<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abonos | Sistema de Gestión</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <nav>
        <div class="container">
            <a href="../index.html" class="logo">
                <i class="fas fa-cash-register"></i> SistemaVentas
            </a>
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
            <ul id="menu">
                <li><a href="../index.html" class="activo">Inicio</a></li>
                <li><a href="ventas.html">Ventas</a></li>
                <li><a href="venta_directa.html">Nueva Venta</a></li>
                <li><a href="venta_descuento.html">Venta con Descuento</a></li>
                <li><a href="abonos.html" class="activo">Abonos</a></li>
                <li><a href="inventario.html">Inventario</a></li>
                <li><a href="ajuste_inventarios.html">Ajuste de Inventario</a></li>
            </ul>
        </div>
    </nav>
    
    <div class="container">
        <h1>Gestión de Abonos</h1>
        
        <div class="card">
            <h2>Buscar Ventas Pendientes</h2>
            <div class="form-group">
                <input type="text" id="buscarVenta" placeholder="Ingrese el nombre del cliente">
                <button id="buscar-btn">
                    <i class="fas fa-search"></i> Buscar
                </button>
            </div>
        </div>
        
        <div class="card" id="detalleVenta" style="display: none;">
            <h2>Detalles de la Venta</h2>
            <p><strong>Cliente:</strong> <span id="cliente"></span></p>
            <p><strong>Vendedor:</strong> <span id="vendedor"></span></p>
            <p><strong>Fecha:</strong> <span id="fecha"></span></p>
            <p><strong>Estado:</strong> <span id="estado"></span></p>
            <p><strong>Valor Total:</strong> $<span id="valorTotal"></span></p>
            <p><strong>Saldo Pendiente:</strong> $<span id="saldoPendiente"></span></p>
            
            <h3>Agregar Abono</h3>
            <div class="form-group">
                <input type="number" id="montoAbono" placeholder="Monto del abono">
                <button id="agregar-abono-btn">
                    <i class="fas fa-plus-circle"></i> Agregar Abono
                </button>
                <button id="marcar-pagado-btn" class="btn-secondary">
                    <i class="fas fa-check-circle"></i> Marcar como Pagado
                </button>
            </div>
            
            <h3>Historial de Abonos</h3>
            <ul id="listaAbonos"></ul>
        </div>
    </div>
    
    <script type="module">
        import { buscarVenta, agregarAbono, marcarComoPagado } from '../scripts/script.js';
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('buscar-btn').addEventListener('click', buscarVentaAbonos);
            document.getElementById('agregar-abono-btn').addEventListener('click', agregarAbonoVenta);
            document.getElementById('marcar-pagado-btn').addEventListener('click', marcarVentaPagada);
        });
        
        async function buscarVentaAbonos() {
            const busqueda = document.getElementById("buscarVenta").value.trim();
            if (!busqueda) {
                alert("Por favor ingrese un ID o nombre de cliente para buscar");
                return;
            }
            
            try {
                let ventaEncontrada = await buscarVenta(busqueda);
                if (ventaEncontrada) {
                    mostrarDetalleVenta(ventaEncontrada);
                } else {
                    alert("No se encontró ninguna venta");
                }
            } catch (error) {
                console.error("Error al buscar venta:", error);
                alert("Error al buscar la venta");
            }
        }
        
        function mostrarDetalleVenta(venta) {
            document.getElementById("detalleVenta").style.display = "block";
            document.getElementById("cliente").textContent = venta.cliente;
            document.getElementById("vendedor").textContent = venta.vendedor;
            document.getElementById("fecha").textContent = new Date(venta.fecha).toLocaleDateString();
            document.getElementById("estado").textContent = venta.estado;
            document.getElementById("valorTotal").textContent = parseFloat(venta.valor).toLocaleString();
            document.getElementById("saldoPendiente").textContent = parseFloat(venta.saldo || venta.valor).toLocaleString();
            document.getElementById("detalleVenta").setAttribute("data-venta-id", venta.id);
        }
        
        async function agregarAbonoVenta() {
            const idVenta = document.getElementById("detalleVenta").getAttribute("data-venta-id");
            const montoAbono = document.getElementById("montoAbono").value;
            
            if (!montoAbono || parseFloat(montoAbono) <= 0) {
                alert("Ingrese un monto válido");
                return;
            }
            
            try {
                const resultado = await agregarAbono(idVenta, montoAbono);
                if (resultado) {
                    alert("Abono registrado correctamente");
                } else {
                    alert("Error al registrar el abono");
                }
            } catch (error) {
                console.error("Error al agregar abono:", error);
                alert("Error al registrar el abono");
            }
        }
        
        async function marcarVentaPagada() {
            const idVenta = document.getElementById("detalleVenta").getAttribute("data-venta-id");
            
            if (confirm("¿Marcar como pagada?")) {
                try {
                    const resultado = await marcarComoPagado(idVenta);
                    if (resultado) {
                        alert("Venta marcada como pagada");
                    } else {
                        alert("Error al marcar la venta");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("Error al marcar la venta");
                }
            }
        }
    </script>
</body>
</html>
