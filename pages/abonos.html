<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de gestión de abonos y pagos pendientes">
    <title>Abonos | Sistema de Gestión</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css">
    <style>
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--nequi-light-gray);
            border-top: 5px solid var(--nequi-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dashboard-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            flex: 1;
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card .icon {
            font-size: 2rem;
            color: var(--nequi-purple);
        }

        .stat-card .value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--nequi-purple);
            color: var(--nequi-purple);
        }

        .btn-outline:hover {
            background: var(--nequi-purple);
            color: #fff;
        }

        .abono-item {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .badge-success {
            background-color: #28a745;
            color: white;
        }

        .mensaje {
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }

        .mensaje-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .mensaje-exito {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .mensaje-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .sugerencias-container {
            position: relative;
            width: 100%;
        }

        .sugerencias {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .sugerencia-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .sugerencia-item:hover, .sugerencia-item.active {
            background-color: #f9f9f9;
        }

        .sugerencia-item:last-child {
            border-bottom: none;
        }
        
        .btn-search {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <nav>
        <div class="container">
            <a href="../index.html" class="logo">
                <i class="fas fa-cash-register"></i> SistemaVentas
            </a>
            <button class="mobile-menu-btn" aria-label="Abrir menú">
                <i class="fas fa-bars"></i>
            </button>
            <ul id="menu">
                <li><a href="../index.html">Inicio</a></li>
                <li><a href="ventas.html">Ventas</a></li>
                <li><a href="venta_directa.html">Nueva Venta</a></li>
                <li><a href="venta_descuento.html">Venta con Descuento</a></li>
                <li><a href="abonos.html" class="activo">Abonos</a></li>
                <li><a href="inventario.html">Inventario</a></li>
                <li><a href="ajuste_inventarios.html">Ajuste de Inventario</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <h1>Gestión de Abonos</h1>

        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="icon">
                    <i class="fas fa-clock"></i>
                </div>
                <h3>Ventas Pendientes</h3>
                <div class="value" id="total-pendientes">0</div>
            </div>
            <div class="stat-card">
                <div class="icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <h3>Total por Cobrar</h3>
                <div class="value" id="total-por-cobrar">$0</div>
            </div>
            <div class="stat-card">
                <div class="icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3>Abonos del Día</h3>
                <div class="value" id="abonos-hoy">$0</div>
            </div>
        </div>

        <div class="card">
            <h2>Buscar Ventas Pendientes</h2>
            <div class="form-group">
                <label for="buscar-cliente">Buscar por Cliente:</label>
                <div class="sugerencias-container">
                    <input type="text" id="buscar-cliente" placeholder="Nombre del cliente">
                    <div id="sugerencias-clientes" class="sugerencias"></div>
                </div>
                <button id="btn-buscar" type="button" class="btn-search" aria-label="Buscar">
                    <i class="fas fa-search"></i> Buscar
                </button>
            </div>
        </div>

        <div id="mensaje" class="mensaje" aria-live="polite"></div>

        <div class="card">
            <h2>Ventas Pendientes</h2>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Contacto</th>
                            <th>Fecha</th>
                            <th>Valor Total</th>
                            <th>Saldo Pendiente</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="ventas-pendientes-body">
                        <!-- Aquí se cargarán las ventas pendientes -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card" id="detalle-venta" style="display: none;">
            <h2>Detalle de Venta</h2>
            <div id="info-venta">
                <!-- Aquí se cargará la información de la venta seleccionada -->
            </div>

            <h3>Registrar Nuevo Abono</h3>
            <form id="form-abono">
                <div class="form-group">
                    <label for="monto-abono">Monto del Abono:</label>
                    <input type="number" id="monto-abono" min="0" step="0.01" required>
                    <small>Saldo pendiente: $<span id="saldo-actual">0</span></small>
                </div>

                <div class="form-group">
                    <label for="fecha-abono">Fecha del Abono:</label>
                    <input type="date" id="fecha-abono" required>
                </div>

                <div class="form-group">
                    <label for="metodo-pago">Método de Pago:</label>
                    <select id="metodo-pago" required>
                        <option value="efectivo">Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                        <option value="tarjeta">Tarjeta</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="comprobante">Número de Comprobante:</label>
                    <input type="text" id="comprobante" placeholder="Opcional">
                </div>

                <div class="form-group">
                    <label for="notas">Notas:</label>
                    <textarea id="notas" rows="2" placeholder="Observaciones adicionales"></textarea>
                </div>

                <div class="button-group">
                    <button type="submit" id="btn-registrar-abono" class="btn-primary">
                        <i class="fas fa-plus-circle"></i> Registrar Abono
                    </button>
                    <button type="button" id="btn-pagar-total" class="btn-secondary">
                        <i class="fas fa-check-circle"></i> Pagar Total
                    </button>
                    <button type="button" id="btn-imprimir" class="btn-outline">
                        <i class="fas fa-print"></i> Imprimir Recibo
                    </button>
                </div>
            </form>

            <h3>Historial de Abonos</h3>
            <div id="historial-abonos">
                <!-- Aquí se cargará el historial de abonos -->
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div>
                <h3>Sistema de Gestión</h3>
                <p>Una solución completa para la gestión de ventas e inventario de tu negocio.</p>
            </div>
            <div>
                <h3>Enlaces Rápidos</h3>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="ventas.html">Ventas</a></li>
                    <li><a href="inventario.html">Inventario</a></li>
                </ul>
            </div>
            <div>
                <h3>Contacto</h3>
                <ul>
                    <li><i class="fas fa-envelope"></i> nicolasmonroy3004@hotmail.com</li>
                    <li><i class="fas fa-phone"></i> +57 314 272 8525</li>
                </ul>
            </div>
        </div>
        <div class="copyright">
            <div class="container">
                <p>&copy; 2025 Sistema de Gestión de Ventas. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script type="module">
        import {
            obtenerVentas,
            escucharVentas,
            buscarVentasPorCliente,
            buscarClientesPorNombre,
            buscarVenta,
            agregarAbono,
            marcarComoPagado
        } from '../scripts/script.js';

        document.addEventListener('DOMContentLoaded', function() {
            const mensaje = document.getElementById('mensaje');
            const buscarClienteInput = document.getElementById('buscar-cliente');
            const sugerenciasClientes = document.getElementById('sugerencias-clientes');
            const btnBuscar = document.getElementById('btn-buscar');
            const detalleVenta = document.getElementById('detalle-venta');
            const formAbono = document.getElementById('form-abono');
            const btnPagarTotal = document.getElementById('btn-pagar-total');
            const btnImprimir = document.getElementById('btn-imprimir');
            const loadingOverlay = document.querySelector('.loading-overlay');

            // Función para mostrar/ocultar el indicador de carga
            function mostrarCargando(mostrar = true) {
                loadingOverlay.style.display = mostrar ? 'flex' : 'none';
            }

            // Establecer la fecha actual por defecto
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fecha-abono').value = hoy;

            // Variable para almacenar la venta seleccionada actualmente
            let ventaSeleccionada = null;

            // Lista de clientes pendientes
            let clientesPendientes = [];

            // Escuchar cambios en ventas para actualizar la lista
            const unsubscribe = escucharVentas(async function(ventas) {
                console.log("Ventas recibidas:", ventas);
                actualizarEstadisticas(ventas);
                const ventasPendientes = ventas.filter(venta =>
                    venta.estado === 'Pendiente' && parseFloat(venta.saldo) > 0
                );
                console.log("Ventas pendientes:", ventasPendientes);

                // Actualizar lista de clientes pendientes para sugerencias
                clientesPendientes = ventasPendientes
                    .map(venta => venta.cliente)
                    .filter((cliente, index, self) =>
                        cliente && // Asegurar que no sea null o undefined
                        self.indexOf(cliente) === index // Eliminar duplicados
                    );

                mostrarVentasPendientes(ventasPendientes);

                if (ventaSeleccionada) {
                    const ventaActualizada = ventas.find(v => v.id === ventaSeleccionada.id);
                    if (ventaActualizada) {
                        ventaSeleccionada = ventaActualizada;
                        mostrarDetalleVenta(ventaActualizada);
                    } else {
                        detalleVenta.style.display = 'none';
                        ventaSeleccionada = null;
                    }
                }
            });

            // Función para realizar la búsqueda
            async function realizarBusqueda(nombreCliente) {
                mostrarMensaje('Buscando ventas...', 'info');
                mostrarCargando(true);

                try {
                    console.log("Iniciando búsqueda para:", nombreCliente);
                    let ventas = [];
                    
                    // Obtener todas las ventas primero (para tener un respaldo si la búsqueda específica falla)
                    const todasLasVentas = await obtenerVentas();
                    console.log("Total de ventas en sistema:", todasLasVentas.length);
                    
                    // Si hay un nombre de cliente, intentamos la búsqueda específica
                    if (nombreCliente && nombreCliente.trim() !== '') {
                        try {
                            console.log("Realizando búsqueda específica para:", nombreCliente);
                            const resultado = await buscarVentasPorCliente(nombreCliente);
                            
                            if (resultado && !resultado.error && resultado.ventas && resultado.ventas.length > 0) {
                                ventas = resultado.ventas;
                                console.log("Ventas encontradas por API:", ventas.length);
                            } else {
                                console.warn("La API de búsqueda no devolvió resultados, usando búsqueda local");
                                // Si la API no devuelve resultados, hacemos búsqueda local
                                ventas = todasLasVentas.filter(venta => 
                                    venta.cliente && 
                                    venta.cliente.toLowerCase().includes(nombreCliente.toLowerCase())
                                );
                                console.log("Ventas encontradas por filtrado local:", ventas.length);
                            }
                        } catch (error) {
                            console.error("Error en búsqueda específica:", error);
                            // En caso de error, usamos búsqueda local
                            ventas = todasLasVentas.filter(venta => 
                                venta.cliente && 
                                venta.cliente.toLowerCase().includes(nombreCliente.toLowerCase())
                            );
                            console.log("Ventas encontradas por filtrado local tras error:", ventas.length);
                        }
                    } else {
                        // Si no hay nombre, usamos todas las ventas
                        ventas = todasLasVentas;
                        console.log("Usando todas las ventas (sin filtro):", ventas.length);
                    }

                    // Filtrar ventas pendientes con saldo > 0
                    const ventasPendientes = ventas.filter(venta => {
                        // Verificar si el cliente coincide con la búsqueda
                        const clienteCoincide = !nombreCliente || 
                                              (venta.cliente && 
                                               venta.cliente.toLowerCase().includes(nombreCliente.toLowerCase()));
                        // Verificar si la venta está pendiente
                        const esPendiente = venta.estado === 'Pendiente' || !venta.estado;
                        // Verificar si tiene saldo pendiente
                        const tieneSaldo = parseFloat(venta.saldo) > 0;
                        
                        return clienteCoincide && esPendiente && tieneSaldo;
                    });

                    console.log("Ventas pendientes filtradas:", ventasPendientes.length);
                    
                    if (ventasPendientes.length > 0) {
                        console.log("Primera venta encontrada:", ventasPendientes[0]);
                        
                        // Calcular el total de saldos pendientes
                        const totalSaldosPendientes = ventasPendientes.reduce((total, venta) => {
                            return total + parseFloat(venta.saldo || 0);
                        }, 0);
                        
                        // Mostrar el total en un mensaje
                        if (nombreCliente && ventasPendientes.length > 0) {
                            const mensajeTotal = document.getElementById('mensaje');
                            mensajeTotal.innerHTML = `<strong>Total pendiente por abonar para ${nombreCliente}:</strong> $${totalSaldosPendientes.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                            mensajeTotal.className = 'mensaje mensaje-info';
                            mensajeTotal.style.display = 'block';
                        }
                    }
                    
                    // Actualizar la tabla con los resultados
                    mostrarVentasPendientes(ventasPendientes);

                    if (ventasPendientes.length === 0) {
                        mostrarMensaje(`No se encontraron ventas pendientes para "${nombreCliente || 'ningún cliente'}"`, 'info');
                    } 
                    // Eliminamos la parte que oculta el mensaje con el total
                    // else {
                    //     // Limpiar mensaje si hay resultados
                    //     document.getElementById('mensaje').style.display = 'none';
                    // }
                } catch (error) {
                    console.error('Error al buscar ventas:', error);
                    mostrarMensaje('Error al buscar ventas pendientes: ' + error.message, 'error');
                } finally {
                    mostrarCargando(false);
                }
            }

            // Funciones para manejar sugerencias
            async function mostrarSugerencias(filtro) {
                if (!filtro || filtro.length < 2) {
                    ocultarSugerencias();
                    return;
                }

                filtro = filtro.toLowerCase();
                mostrarCargando(true);
                
                try {
                    // Buscar clientes en la base de datos que coincidan con el filtro
                    const clientesEncontrados = await buscarClientesPorNombre(filtro);
                    
                    if (clientesEncontrados && clientesEncontrados.length > 0) {
                        // Extraer solo los nombres de clientes
                        const nombresClientes = clientesEncontrados.map(c => c.nombre);
                        // Eliminar duplicados
                        const clientesUnicos = [...new Set(nombresClientes)];
                        // Actualizar la lista de clientes pendientes
                        clientesPendientes = clientesUnicos;
                    } else if (clientesPendientes.length === 0) {
                        // Si no hay resultados de la búsqueda y no tenemos clientes en caché
                        // intentar obtenerlos de todas las ventas como respaldo
                        const ventas = await obtenerVentas();
                        clientesPendientes = ventas
                            .filter(venta => venta.cliente) // Asegurar que hay cliente
                            .map(venta => venta.cliente)
                            .filter((cliente, index, self) => self.indexOf(cliente) === index); // Eliminar duplicados
                    }
                    
                    procesarSugerencias(filtro);
                } catch (error) {
                    console.error("Error al obtener clientes para sugerencias:", error);
                } finally {
                    mostrarCargando(false);
                }
            }

            function procesarSugerencias(filtro) {
                const clientesFiltrados = clientesPendientes
                    .filter(cliente => cliente && cliente.toLowerCase().includes(filtro))
                    .slice(0, 10); // Limitar a 10 sugerencias

                if (clientesFiltrados.length === 0) {
                    ocultarSugerencias();
                    return;
                }

                const sugerenciasHTML = clientesFiltrados.map(cliente =>
                    `<div class="sugerencia-item" data-cliente="${cliente}">${cliente}</div>`
                ).join('');

                sugerenciasClientes.innerHTML = sugerenciasHTML;
                sugerenciasClientes.style.display = 'block';

                // Agregar event listeners a los items de sugerencia
                const items = sugerenciasClientes.querySelectorAll('.sugerencia-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const nombreCliente = this.dataset.cliente;
                        buscarClienteInput.value = nombreCliente;
                        ocultarSugerencias();
                        realizarBusqueda(nombreCliente);
                    });
                });
            }

            function ocultarSugerencias() {
                sugerenciasClientes.style.display = 'none';
            }

            // Event listeners para el input de búsqueda
            buscarClienteInput.addEventListener('input', function() {
                const valor = this.value.trim();
                mostrarSugerencias(valor);
            });

            buscarClienteInput.addEventListener('focus', function() {
                const valor = this.value.trim();
                if (valor.length >= 2) {
                    mostrarSugerencias(valor);
                }
            });

            buscarClienteInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    ocultarSugerencias();
                } else if (e.key === 'Enter') {
                    ocultarSugerencias();
                    realizarBusqueda(this.value.trim());
                } else if (e.key === 'ArrowDown' && sugerenciasClientes.style.display === 'block') {
                    // Navegar por las sugerencias con flecha abajo
                    const items = sugerenciasClientes.querySelectorAll('.sugerencia-item');
                    const activeItem = sugerenciasClientes.querySelector('.sugerencia-item.active');
                    if (!activeItem && items.length > 0) {
                        items[0].classList.add('active');
                    } else if (activeItem) {
                        const nextItem = activeItem.nextElementSibling;
                        if (nextItem) {
                            activeItem.classList.remove('active');
                            nextItem.classList.add('active');
                        }
                    }
                    e.preventDefault();
                } else if (e.key === 'ArrowUp' && sugerenciasClientes.style.display === 'block') {
                    // Navegar por las sugerencias con flecha arriba
                    const items = sugerenciasClientes.querySelectorAll('.sugerencia-item');
                    const activeItem = sugerenciasClientes.querySelector('.sugerencia-item.active');

                    if (activeItem) {
                        const prevItem = activeItem.previousElementSibling;
                        if (prevItem) {
                            activeItem.classList.remove('active');
                            prevItem.classList.add('active');
                        }
                    }
                    e.preventDefault();
                }
            });

            // Cerrar sugerencias cuando se hace clic fuera
            document.addEventListener('click', function(e) {
                if (!sugerenciasClientes.contains(e.target) && e.target !== buscarClienteInput) {
                    ocultarSugerencias();
                }
            });

            // Mantener el botón de búsqueda
            btnBuscar.addEventListener('click', function() {
                const nombreCliente = buscarClienteInput.value.trim();
                ocultarSugerencias();
                realizarBusqueda(nombreCliente);
            });

            // Registrar abono
            formAbono.addEventListener('submit', async function(e) {
                e.preventDefault();
                mostrarCargando(true);

                if (!ventaSeleccionada) {
                    mostrarMensaje('No hay venta seleccionada', 'error');
                    mostrarCargando(false);
                    return;
                }

                const montoAbono = parseFloat(document.getElementById('monto-abono').value);

                if (isNaN(montoAbono) || montoAbono <= 0) {
                    mostrarMensaje('Ingrese un monto válido', 'error');
                    mostrarCargando(false);
                    return;
                }

                if (montoAbono > parseFloat(ventaSeleccionada.saldo)) {
                    mostrarMensaje('El abono no puede ser mayor que el saldo pendiente', 'error');
                    mostrarCargando(false);
                    return;
                }

                try {
                    // Crear objeto de abono con todos los datos
                    const nuevoAbono = {
                        monto: montoAbono,
                        fecha: document.getElementById('fecha-abono').value,
                        metodoPago: document.getElementById('metodo-pago').value,
                        comprobante: document.getElementById('comprobante').value,
                        notas: document.getElementById('notas').value
                    };

                    // Pasar el objeto completo de abono a la función
                    const resultado = await agregarAbono(ventaSeleccionada.id, nuevoAbono);

                    mostrarMensaje(resultado ? 'Abono registrado con éxito' : 'Error al registrar el abono', resultado ? 'exito' : 'error');

                    if (resultado) {
                        document.getElementById('monto-abono').value = '';
                        document.getElementById('comprobante').value = '';
                        document.getElementById('notas').value = '';
                        imprimirRecibo(ventaSeleccionada, montoAbono);
                    }
                } catch (error) {
                    console.error('Error al registrar abono:', error);
                    mostrarMensaje('Error al registrar el abono: ' + error.message, 'error');
                } finally {
                    mostrarCargando(false);
                }
            });

            // Pagar total
            btnPagarTotal.addEventListener('click', async function() {
                if (!ventaSeleccionada) {
                    mostrarMensaje('No hay venta seleccionada', 'error');
                    return;
                }

                if (confirm(`¿Está seguro de marcar como pagada la venta de ${ventaSeleccionada.cliente}?`)) {
                    mostrarCargando(true);
                    try {
                        const resultado = await marcarComoPagado(ventaSeleccionada.id);
                        mostrarMensaje(resultado ? 'Venta marcada como pagada con éxito' : 'Error al marcar la venta como pagada', resultado ? 'exito' : 'error');
                        if (resultado) {
                            detalleVenta.style.display = 'none';
                            ventaSeleccionada = null;
                        }
                    } catch (error) {
                        console.error('Error al marcar como pagado:', error);
                        mostrarMensaje('Error al marcar la venta como pagada: ' + error.message, 'error');
                    } finally {
                        mostrarCargando(false);
                    }
                }
            });

            // Imprimir recibo
            btnImprimir.addEventListener('click', () => {
                const montoAbonoInput = document.getElementById('monto-abono').value;
                if (ventaSeleccionada && montoAbonoInput) {
                    imprimirRecibo(ventaSeleccionada, parseFloat(montoAbonoInput));
                } else {
                    mostrarMensaje('Complete los datos del abono primero', 'error');
                }
            });

            // Menú móvil
            const menuBtn = document.querySelector('.mobile-menu-btn');
            const menu = document.getElementById('menu');

            menuBtn.addEventListener('click', function() {
                menu.classList.toggle('show');
            });

            // Función para mostrar ventas pendientes
            function mostrarVentasPendientes(ventas) {
                const ventasPendientesBody = document.getElementById('ventas-pendientes-body');
                
                if (!ventas || ventas.length === 0) {
                    ventasPendientesBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No hay ventas pendientes</td></tr>';
                    return;
                }

                console.log(`Mostrando ${ventas.length} ventas pendientes`);
                
                ventasPendientesBody.innerHTML = ventas.map((venta, index) => {
                    // Asegurarse de que los valores numéricos sean números
                    const valor = parseFloat(venta.valor) || 0;
                    const saldo = parseFloat(venta.saldo) || 0;
                    
                    console.log(`Preparando venta #${index+1}: Cliente=${venta.cliente}, Saldo=${saldo}`);

                    return `
                        <tr>
                            <td>${venta.cliente || 'Sin nombre'}</td>
                            <td>${venta.contacto || 'Sin contacto'}</td>
                            <td>${venta.fecha ? new Date(venta.fecha).toLocaleDateString() : 'Fecha no disponible'}</td>
                            <td>$${valor.toLocaleString()}</td>
                            <td class="saldo-pendiente">$${saldo.toLocaleString()}</td>
                            <td><span class="badge badge-warning">${venta.estado || 'Pendiente'}</span></td>
                            <td>
                                <button class="btn-icon btn-ver-detalle" data-venta-id="${venta.id}" aria-label="Ver detalle de venta">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Función para mostrar detalle de venta
            async function mostrarDetalleVenta(venta) {
                const infoVenta = document.getElementById('info-venta');
                const historialAbonos = document.getElementById('historial-abonos');

                // Asegurarse de que los valores numéricos sean números
                const valor = parseFloat(venta.valor) || 0;
                const saldo = parseFloat(venta.saldo) || 0;

                // Mostrar información de la venta
                infoVenta.innerHTML = `
                    <p><strong>Cliente:</strong> ${venta.cliente || 'Sin nombre'}</p>
                    <p><strong>Contacto:</strong> ${venta.contacto || 'Sin contacto'}</p>
                    <p><strong>Fecha de venta:</strong> ${venta.fecha ? new Date(venta.fecha).toLocaleDateString() : 'Fecha no disponible'}</p>
                    <p><strong>Valor total:</strong> $${valor.toLocaleString()}</p>
                    <p><strong>Saldo pendiente:</strong> $${saldo.toLocaleString()}</p>
                `;
                document.getElementById('saldo-actual').textContent = saldo.toLocaleString();

                // Mostrar historial de abonos
                if (venta.abonos && Array.isArray(venta.abonos) && venta.abonos.length > 0) {
                    const abonosHTML = venta.abonos.map(abono => {
                        // Asegurarse de que el monto sea un número
                        const monto = parseFloat(abono.monto) || 0;

                        return `
                            <div class="abono-item">
                                <p><strong>Fecha:</strong> ${abono.fecha ? new Date(abono.fecha).toLocaleDateString() : 'Fecha no disponible'}</p>
                                <p><strong>Monto:</strong> $${monto.toLocaleString()}</p>
                                <p><strong>Método de pago:</strong> ${abono.metodoPago || 'No especificado'}</p>
                                ${abono.comprobante ? `<p><strong>Comprobante:</strong> ${abono.comprobante}</p>` : ''}
                                ${abono.notas ? `<p><strong>Notas:</strong> ${abono.notas}</p>` : ''}
                            </div>
                        `;
                    }).join('<hr>');
                    historialAbonos.innerHTML = abonosHTML;
                } else {
                    historialAbonos.innerHTML = '<p>No hay abonos registrados para esta venta.</p>';
                }

                detalleVenta.style.display = 'block';
            }

            // Función para actualizar estadísticas
            function actualizarEstadisticas(ventas) {
                if (!ventas || !Array.isArray(ventas)) {
                    console.error("No se recibieron ventas válidas para actualizar estadísticas");
                    return;
                }

                const ventasPendientes = ventas.filter(venta =>
                    venta.estado === 'Pendiente' && parseFloat(venta.saldo) > 0
                );
                const totalPendientes = ventasPendientes.length;
                const totalPorCobrar = ventasPendientes.reduce((total, venta) => {
                    const saldo = parseFloat(venta.saldo) || 0;
                    return total + saldo;
                }, 0);

                // Calcular abonos del día
                const hoy = new Date().toISOString().split('T')[0];
                let abonosHoy = 0;

                ventas.forEach(venta => {
                    if (venta.abonos && Array.isArray(venta.abonos)) {
                        venta.abonos.forEach(abono => {
                            if (abono.fecha) {
                                const fechaAbono = new Date(abono.fecha).toISOString().split('T')[0];
                                if (fechaAbono === hoy) {
                                    abonosHoy += parseFloat(abono.monto) || 0;
                                }
                            }
                        });
                    }
                });

                document.getElementById('total-pendientes').textContent = totalPendientes;
                document.getElementById('total-por-cobrar').textContent = '$' + totalPorCobrar.toLocaleString();
                document.getElementById('abonos-hoy').textContent = '$' + abonosHoy.toLocaleString();

                console.log("Estadísticas actualizadas:", {
                    totalPendientes,
                    totalPorCobrar,
                    abonosHoy
                });
            }

            // Función para mostrar mensaje
            function mostrarMensaje(texto, tipo) {
                mensaje.textContent = texto;
                mensaje.className = 'mensaje';
                mensaje.classList.add(`mensaje-${tipo}`);
                mensaje.style.display = 'block';

                setTimeout(() => {
                    mensaje.style.display = 'none';
                }, 5000);
            }

            // Función para imprimir recibo
            function imprimirRecibo(venta, montoAbono) {
                const metodoPago = document.getElementById('metodo-pago').value;
                const comprobante = document.getElementById('comprobante').value;
                const fechaAbono = document.getElementById('fecha-abono').value;
                const notas = document.getElementById('notas').value;

                // Asegurarse de que los valores numéricos sean números
                const valor = parseFloat(venta.valor) || 0;
                const saldo = parseFloat(venta.saldo) || 0;
                montoAbono = parseFloat(montoAbono) || 0;

                const ventanaImpresion = window.open('', '_blank');
                ventanaImpresion.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Recibo de Abono</title>
                        <style>
                            body {
                                font-family: Arial, sans-serif;
                                margin: 0;
                                padding: 20px;
                                font-size: 14px;
                            }
                            .recibo {
                                max-width: 300px;
                                margin: 0 auto;
                            }
                            .header {
                                text-align: center;
                                margin-bottom: 20px;
                            }
                            .info-item {
                                margin-bottom: 5px;
                            }
                            .total {
                                margin-top: 15px;
                                font-weight: bold;
                                border-top: 1px solid #000;
                                padding-top: 5px;
                            }
                            .footer {
                                margin-top: 30px;
                                text-align: center;
                                font-size: 12px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="recibo">
                            <div class="header">
                                <h2>RECIBO DE ABONO</h2>
                                <p>Sistema de Gestión de Ventas</p>
                            </div>
                            <div class="info-item"><strong>Fecha:</strong> ${new Date(fechaAbono).toLocaleDateString()}</div>
                            <div class="info-item"><strong>Cliente:</strong> ${venta.cliente || 'Sin nombre'}</div>
                            <div class="info-item"><strong>Contacto:</strong> ${venta.contacto || 'Sin contacto'}</div>
                            <div class="info-item"><strong>Fecha de venta:</strong> ${venta.fecha ? new Date(venta.fecha).toLocaleDateString() : 'Fecha no disponible'}</div>
                            <div class="info-item"><strong>Valor total de la venta:</strong> $${valor.toLocaleString()}</div>
                            <div class="info-item"><strong>Saldo anterior:</strong> $${saldo.toLocaleString()}</div>
                            <div class="info-item"><strong>Monto abonado:</strong> $${montoAbono.toLocaleString()}</div>
                            <div class="info-item"><strong>Método de pago:</strong> ${metodoPago}</div>
                            ${comprobante ? `<div class="info-item"><strong>Comprobante:</strong> ${comprobante}</div>` : ''}
                            <div class="total">Saldo pendiente: $${(saldo - montoAbono).toLocaleString()}</div>

                            ${notas ? `<div class="info-item"><strong>Notas:</strong> ${notas}</div>` : ''}

                            <div class="footer">
                                <p>¡Gracias por su pago!</p>
                                <p>Este documento es un comprobante de pago.</p>
                            </div>
                        </div>
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 500);
                            }
                        
                `);

                ventanaImpresion.document.close();
            }

            // Exponer la función verDetalleVenta globalmente
            window.verDetalleVenta = async function(ventaId) {
                mostrarCargando(true);
                try {
                    const venta = await buscarVenta(ventaId);
                    if (venta) {
                        ventaSeleccionada = venta;
                        mostrarDetalleVenta(venta);
                    } else {
                        mostrarMensaje('No se encontró la venta', 'error');
                    }
                } catch (error) {
                    console.error('Error al obtener detalle de venta:', error);
                    mostrarMensaje('Error al obtener detalle de venta: ' + error.message, 'error');
                } finally {
                    mostrarCargando(false);
                }
            };
            
            // Al cargar la página, buscar todas las ventas pendientes
            realizarBusqueda('');
        });
    </script>
</body>
</html>
