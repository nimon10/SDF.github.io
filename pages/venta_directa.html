<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venta Directa | Sistema de Gestión</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <nav>
        <div class="container">
            <a href="../index.html" class="logo">
                <i class="fas fa-cash-register"></i> SistemaVentas
            </a>
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i> 
            </button>
            <ul id="menu">
                <li><a href="../index.html">Inicio</a></li>
                <li><a href="ventas.html">Ventas</a></li>
                <li><a href="venta_directa.html" class="activo">Nueva Venta</a></li>
                <li><a href="venta_descuento.html">Venta con Descuento</a></li>
                <li><a href="abonos.html">Abonos</a></li>
                <li><a href="inventario.html">Inventario</a></li>
                <li><a href="ajuste_inventarios.html">Ajuste de Inventario</a></li>
            </ul>
        </div>
    </nav>
    
    <div class="container">
        <h1>Venta Directa</h1>
        
        <div class="card">
            <h2>Datos de la Venta</h2>
            <form id="formulario-venta">
                <div class="form-group sugerencias-container">
                    <label for="cliente">Nombre del Cliente:</label>
                   <input type="text" id="cliente" name="cliente" placeholder="Nombre completo del cliente" required>
                    <div class="sugerencias-lista" id="sugerencias-cliente"></div>
               </div>
                
                <div class="form-group">
                    <label for="contacto">Número de Contacto:</label>
                    <input type="text" id="contacto" name="contacto" placeholder="Número de teléfono" required>
                </div>
                
                <div class="form-group">
                    <label for="vendedor">Vendedor:</label>
                    <select id="vendedor" name="vendedor" required>
                        <option value="">Seleccione un vendedor</option>
                        <option value="Gladys">Gladys</option>
                        <option value="David">David</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="revista">Revista:</label>
                    <select id="revista" name="revista" required>
                        <option value="">Seleccione una revista</option>
                        <option value="Esika">Esika</option>
                        <option value="Carmel">Carmel</option>
                        <option value="Leonisa">Leonisa</option>
                        <option value="Cyzone">Cyzone</option>
                        <option value="Pacifika">Pacifika</option>
                        <option value="Yanbal">Yanbal</option>
                        <option value="L'ebel">L'ebel</option>
                        <option value="Novaventa">Novaventa</option>
                        <option value="Natura">Natura</option>
                        <option value="Login">Login</option>
                        <option value="Avon">Avon</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="fecha-venta">Fecha de Venta:</label>
                    <input type="date" id="fecha-venta" name="fecha-venta" required>
                </div>


                <div class="form-group">
                    <label for="valor-venta">Valor de la Venta:</label>
                    <input type="number" id="valor-venta" name="valor-venta" min="0" step="0.01" placeholder="Valor total de la venta" required>
                </div>
                
                <div class="form-group">
                    <label for="descripcion-venta">Descripción (opcional):</label>
                    <textarea id="descripcion-venta" name="descripcion-venta" placeholder="Detalles adicionales de la venta"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="estado-venta">Estado de la Venta:</label>
                    <select id="estado-venta" name="estado-venta" required>
                        <option value="Completado">Completado</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                
                <button type="submit" id="btn-registrar-venta">
                    <i class="fas fa-check-circle"></i> Registrar Venta
                </button>
            </form>
        </div>
        
        <div id="mensaje" class="mensaje"></div>
        
        <div class="card">
            <h2>Historial de Ventas Recientes</h2>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Vendedor</th>
                            <th>Revista</th>
                            <th>Valor</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="historial-body">
                        <!-- Aquí se cargará el historial de ventas -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <div>
                <h3>Sistema de Gestión</h3>
                <p>Una solución completa para la gestión de ventas e inventario de tu negocio.</p>
            </div>
            <div>
                <h3>Enlaces Rápidos</h3>
                <ul>
                    <li><a href="../index.html">Inicio</a></li>
                    <li><a href="ventas.html">Ventas</a></li>
                    <li><a href="inventario.html">Inventario</a></li>
                </ul>
            </div>
            <div>
                <h3>Contacto</h3>
                <ul>
                    <li><i class="fas fa-envelope"></i> info@sistemaventas.com</li>
                    <li><i class="fas fa-phone"></i> +57 314 272 8525</li>
                </ul>
            </div>
        </div>
        <div class="copyright">
            <div class="container">
                <p>&copy; 2025 Sistema de Gestión de Ventas. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>
    
   <script type="module">
    import { db } from '../scripts/firebase-config.js';
    
    import { 
        guardarVenta,
        escucharVentas,
        eliminarVenta,
        buscarClientesPorNombre
    } from '../scripts/script.js';
    
    document.addEventListener('DOMContentLoaded', function() {
        const formularioVenta = document.getElementById('formulario-venta');
        const mensaje = document.getElementById('mensaje');
        const clienteInput = document.getElementById('cliente');
        const contactoInput = document.getElementById('contacto');
        const sugerenciasLista = document.getElementById('sugerencias-cliente');
        
        // Establecer la fecha actual por defecto
        const hoy = new Date().toISOString().split('T')[0];
        document.getElementById('fecha-venta').value = hoy;
        
        // Escuchar cambios en ventas para actualizar historial
        const unsubscribeVentas = escucharVentas(function(ventas) {
            // Filtrar solo ventas directas
            const ventasDirectas = ventas.filter(venta => venta.tipoVenta === 'directa');
            mostrarHistorial(ventasDirectas);
        });
        
        // Implementar autocompletado de contacto al escribir el nombre del cliente
        let timeoutId;
        clienteInput.addEventListener('input', function() {
            // Limpiar el timeout anterior para evitar múltiples búsquedas
            clearTimeout(timeoutId);
            
            // Esperar a que el usuario termine de escribir
            timeoutId = setTimeout(async function() {
                const nombreCliente = clienteInput.value.trim();
                if (nombreCliente.length >= 3) { // Buscar solo si hay al menos 3 caracteres
                    const clientes = await buscarClientesPorNombre(nombreCliente);
                    
                    // Mostrar sugerencias
                    if (clientes.length > 0) {
                        mostrarSugerencias(clientes);
                    } else {
                        ocultarSugerencias();
                    }
                    
                    // Si encontramos una coincidencia exacta, autocompletar el contacto
                    const clienteExacto = clientes.find(c => c.nombre.toLowerCase() === nombreCliente.toLowerCase());
                    if (clienteExacto) {
                        contactoInput.value = clienteExacto.contacto;
                    }
                } else {
                    ocultarSugerencias();
                }
            }, 300); // Esperar 300ms después de que el usuario deje de escribir
        });
        
        // Ocultar sugerencias al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!clienteInput.contains(e.target) && !sugerenciasLista.contains(e.target)) {
                ocultarSugerencias();
            }
        });
        
        // Registrar nueva venta
        formularioVenta.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const cliente = document.getElementById('cliente').value;
            const contacto = document.getElementById('contacto').value;
            const vendedor = document.getElementById('vendedor').value;
            const revista = document.getElementById('revista').value;
            const fecha = document.getElementById('fecha-venta').value;
            const valor = parseFloat(document.getElementById('valor-venta').value);
            const descripcion = document.getElementById('descripcion-venta').value;
            const estado = document.getElementById('estado-venta').value;
            
            // Crear objeto de venta
            const venta = {
                cliente,
                contacto,
                vendedor,
                revista,
                fecha,
                valor,
                descripcion,
                estado,
                tipoVenta: 'directa'
            };
            
            try {
                // Guardar venta
                const resultado = await guardarVenta(venta);
                
                if (resultado) {
                    mostrarMensaje('Venta registrada con éxito', 'exito');
                    formularioVenta.reset();
                    document.getElementById('fecha-venta').value = hoy; // Restablecer la fecha a hoy
                } else {
                    mostrarMensaje('Error al registrar la venta', 'error');
                }
            } catch (error) {
                console.error('Error al procesar la venta:', error);
                mostrarMensaje('Error al procesar la venta', 'error');
            }
        });
        
        // Menú móvil
        const menuBtn = document.querySelector('.mobile-menu-btn');
        const menu = document.getElementById('menu');
        
        menuBtn.addEventListener('click', function() {
            menu.classList.toggle('show');
        });
        
        // Función para mostrar sugerencias
        function mostrarSugerencias(clientes) {
            sugerenciasLista.innerHTML = '';
            
            clientes.forEach(cliente => {
                const item = document.createElement('div');
                item.className = 'sugerencia-item';
                item.innerHTML = `
                    <div class="sugerencia-nombre">${cliente.nombre}</div>
                    <div class="sugerencia-contacto">${cliente.contacto}</div>
                `;
                
                item.addEventListener('click', function() {
                    clienteInput.value = cliente.nombre;
                    contactoInput.value = cliente.contacto;
                    ocultarSugerencias();
                });
                
                sugerenciasLista.appendChild(item);
            });
            
            sugerenciasLista.classList.add('mostrar');
        }
        
        // Función para ocultar sugerencias
        function ocultarSugerencias() {
            sugerenciasLista.classList.remove('mostrar');
        }
        
        // Función para mostrar historial de ventas
        function mostrarHistorial(ventas) {
            const historialBody = document.getElementById('historial-body');
            
            // Ordenar ventas por fecha (más recientes primero)
            ventas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            // Mostrar solo las últimas 10 ventas
            const ventasRecientes = ventas.slice(0, 10);
            
            historialBody.innerHTML = '';
            
            if (ventasRecientes.length === 0) {
                historialBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No hay ventas registradas</td></tr>';
                return;
            }
            
            ventasRecientes.forEach(venta => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${new Date(venta.fecha).toLocaleDateString()}</td>
                    <td>${venta.cliente}</td>
                    <td>${venta.vendedor}</td>
                    <td>${venta.revista || '-'}</td>
                    <td>$${parseFloat(venta.valor).toLocaleString()}</td>
                    <td><span class="badge ${venta.estado === 'Completado' ? 'badge-success' : venta.estado === 'Cancelado' ? 'badge-danger' : 'badge-warning'}">${venta.estado}</span></td>
                    <td>
                        <button class="btn-icon" onclick="eliminarVentaUI('${venta.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                historialBody.appendChild(fila);
            });
        }
        
        // Función para mostrar mensajes
        function mostrarMensaje(texto, tipo) {
            mensaje.innerHTML = `<div class="mensaje ${tipo}"><i class="fas fa-${tipo === 'exito' ? 'check' : 'exclamation'}-circle"></i> ${texto}</div>`;
            
            setTimeout(() => {
                mensaje.innerHTML = '';
            }, 3000);
        }
        
        // Función para eliminar una venta (disponible globalmente)
        window.eliminarVentaUI = async function(id) {
            if (confirm('¿Estás seguro de eliminar esta venta? Esta acción no se puede deshacer.')) {
                try {
                    const resultado = await eliminarVenta(id);
                    
                    if (resultado) {
                        mostrarMensaje('Venta eliminada con éxito', 'exito');
                    } else {
                        mostrarMensaje('Error al eliminar la venta', 'error');
                    }
                } catch (error) {
                    console.error('Error al eliminar venta:', error);
                    mostrarMensaje('Error al eliminar la venta', 'error');
                }
            }
        };
    });
</script>

</body>
</html>
